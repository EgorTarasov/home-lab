# –î–æ–º–∞—à–Ω—è—è –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è

–≠—Ç–æ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–µ–π –¥–æ–º–∞—à–Ω–µ–π –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ —Å –ø–æ–º–æ—â—å—é –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –∏ —Å–∫—Ä–∏–ø—Ç–æ–≤.
–í–∫–ª—é—á–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:
- **k3s**: –õ–µ–≥–∫–æ–≤–µ—Å–Ω—ã–π Kubernetes-–∫–ª–∞—Å—Ç–µ—Ä
- **cert-manager**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏ —á–µ—Ä–µ–∑ Let's Encrypt –∏ Cloudflare DNS
- **Rancher**: –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Kubernetes
- **Cloudflare**: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ DNS –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
- **Pi-hole**: DNS-—Ä–µ–∑–æ–ª–≤–µ—Ä –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏ (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)
- **WireGuard**: VPN-—Å–µ—Ä–≤–µ—Ä –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)
- **–°—Ç–µ–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞**: Prometheus –∏ Grafana (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)
- **Terraform**: –ö–æ–¥ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è Argo CD –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤

## –¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- **home-lab-node-1** (192.168.1.51) ‚Äî —É–∑–µ–ª —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è k3s
  - –†–æ–ª—å: control-plane
  - CPU: 16 —è–¥–µ—Ä
  - –°–µ—Ç—å: Flannel CNI (VXLAN)
  - –°–µ—Ä–≤–∏—Å—ã: k3s server, cert-manager, Rancher

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Terraform
–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –∫–∞—Ç–∞–ª–æ–≥–µ `terraform/`:
- `0-provider.tf` ‚Äî –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ Terraform (Cloudflare, Kubernetes –∏ —Ç.–¥.)
- `1-argocd.tf` ‚Äî —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ Argo CD –≤ k3s-–∫–ª–∞—Å—Ç–µ—Ä–µ

–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:
```bash
cd terraform
terraform init
terraform apply
```

## –°–ª—É–∂–±—ã –∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### üîê –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏
- **cert-manager**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ Let's Encrypt
- **DNS-01 Challenge**: –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ Cloudflare API
- **–î–æ–º–µ–Ω—ã**: `*.k3s.larek.tech`
- **ClusterIssuer**: `cloudflare-clusterissuer`

### üéõÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–æ–º
- **Rancher UI**: –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Kubernetes
  - URL: `https://rancher.k3s.larek.tech`
  - SSL: –∏–∑ cert-manager
  - –ü–∞—Ä–æ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: admin

### üåê –°–µ—Ç—å
- **–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Å–µ—Ç—å**: 192.168.1.0/24
- **Pod CIDR**: 10.42.0.0/24
- **–í–Ω–µ—à–Ω–∏–π –¥–æ–º–µ–Ω**: `larek.tech` —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è Cloudflare
- **–ü–æ–¥–¥–æ–º–µ–Ω K3s**: `*.k3s.larek.tech` –¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤ –∫–ª–∞—Å—Ç–µ—Ä–∞

## –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é –∏ —Å–µ–∫—Ä–µ—Ç–∞–º–∏

### –ß—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –∫–æ–º–º–∏—Ç–∏—Ç—å:
- ‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–µ IP-–∞–¥—Ä–µ—Å–∞ (192.168.x.x, 10.x.x.x, 172.16-31.x.x)
- ‚úÖ –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ DNS-–∏–º–µ–Ω–∞ –∏ —Ç–æ–ø–æ–ª–æ–≥–∏—è —Å–µ—Ç–∏
- ‚úÖ –®–∞–±–ª–æ–Ω—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π (.env.example —Ñ–∞–π–ª—ã)
- ‚úÖ –ù–æ–º–µ—Ä–∞ –ø–æ—Ä—Ç–æ–≤ –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

### –ß—Ç–æ –ù–ò–ö–û–ì–î–ê –Ω–µ —Å–ª–µ–¥—É–µ—Ç –∫–æ–º–º–∏—Ç–∏—Ç—å:
- ‚ùå API —Ç–æ–∫–µ–Ω—ã –∏ –∫–ª—é—á–∏ (Cloudflare, GitHub –∏ —Ç.–¥.)
- ‚ùå –ü—É–±–ª–∏—á–Ω—ã–µ IP-–∞–¥—Ä–µ—Å–∞
- ‚ùå –ü–∞—Ä–æ–ª–∏ –∏ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- ‚ùå SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –∏ –∑–∞–∫—Ä—ã—Ç—ã–µ –∫–ª—é—á–∏
- ‚ùå MAC-–∞–¥—Ä–µ—Å–∞ (–º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è)

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–∞–º–∏:
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `.env.example` —Ñ–∞–π–ª—ã –≤ –∫–∞—á–µ—Å—Ç–≤–µ —à–∞–±–ª–æ–Ω–æ–≤
- –•—Ä–∞–Ω–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã –≤ GitHub Secrets –¥–ª—è CI/CD
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Kubernetes Secrets –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è External Secrets Operator –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞


## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
```
‚îú‚îÄ‚îÄ clusters/                         # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞ k3s (gitignored)
‚îÇ   ‚îú‚îÄ‚îÄ kubeconfig.yaml         # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞ K3s (gitignored)
‚îÇ   ‚îî‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ configs/                          # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ —à–∞–±–ª–æ–Ω—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ network.md                        # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —Å–µ—Ç–µ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ pi-hole/                          # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Pi-hole (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)
‚îÇ   ‚îî‚îÄ‚îÄ wireguard/                        # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ WireGuard VPN (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)
‚îú‚îÄ‚îÄ environments/                     # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –æ–∫—Ä—É–∂–µ–Ω–∏–π (dev, prod)
‚îÇ   ‚îú‚îÄ‚îÄ dev/                               # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
‚îÇ   ‚îî‚îÄ‚îÄ production/                         # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
‚îú‚îÄ‚îÄ k3s/                              # –°–∫—Ä–∏–ø—Ç—ã –∏ –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã –¥–ª—è k3s
‚îÇ   ‚îú‚îÄ‚îÄ cluster-config/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cert-manager/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ clusterissuer.yaml        # Cloudflare ClusterIssuer –¥–ª—è Let's Encrypt
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ secret-cloudflare.yaml    # –°–µ–∫—Ä–µ—Ç —Å —Ç–æ–∫–µ–Ω–æ–º Cloudflare
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ rancher/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ certificate.yaml          # SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –¥–ª—è Rancher UI
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ ui.sh                     # –°–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Rancher
‚îÇ   ‚îú‚îÄ‚îÄ ingress/                          # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Ingress (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)
‚îÇ   ‚îî‚îÄ‚îÄ monitoring/                       # –°—Ç–µ–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)
‚îú‚îÄ‚îÄ scripts/                          # –°–∫—Ä–∏–ø—Ç—ã —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —É–∑–ª–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ master.sh                         # –°–∫—Ä–∏–ø—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–ª–∞–≤–Ω–æ–≥–æ —É–∑–ª–∞ K3s
‚îÇ   ‚îî‚îÄ‚îÄ worker.sh                         # –°–∫—Ä–∏–ø—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞–±–æ—á–µ–≥–æ —É–∑–ª–∞ K3s
‚îú‚îÄ‚îÄ terraform/                        # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Terraform
‚îÇ   ‚îú‚îÄ‚îÄ 0-provider.tf
‚îÇ   ‚îî‚îÄ‚îÄ 1-argocd.tf
‚îî‚îÄ‚îÄ readme.md                         # –≠—Ç–æ—Ç —Ñ–∞–π–ª
```

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞ k3s
```bash
# –ù–∞ –≥–ª–∞–≤–Ω–æ–º —É–∑–ª–µ
./scripts/master.sh

# –ù–∞ —Ä–∞–±–æ—á–∏—Ö —É–∑–ª–∞—Ö (—Å–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è)
export K3S_URL="https://192.168.1.51:6443"
export K3S_TOKEN="<—Ç–æ–∫–µ–Ω-—É–∑–ª–∞-—Å-–≥–ª–∞–≤–Ω–æ–≥–æ>"
./scripts/worker.sh
```

### 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ cert-manager
```bash
# –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π Jetstack
helm repo add jetstack https://charts.jetstack.io
helm repo update

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å cert-manager
helm install cert-manager jetstack/cert-manager \
  --namespace cert-manager \
  --create-namespace \
  --version v1.18.2 \
  --set crds.enabled=true

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–µ–∫—Ä–µ—Ç Cloudflare (–æ–±–Ω–æ–≤–∏—Ç–µ —Å–≤–æ–∏–º —Ç–æ–∫–µ–Ω–æ–º API)
kubectl apply -f k3s/cluster-config/cert-manager/secret-cloudflare.yaml

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å ClusterIssuer
kubectl apply -f k3s/cluster-config/cert-manager/clusterissuer.yaml
```

### 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Rancher UI
```bash
# –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –∏–º–µ–Ω
kubectl create namespace cattle-system

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
kubectl apply -f k3s/cluster-config/rancher/certificate.yaml

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Rancher
chmod +x k3s/cluster-config/rancher/ui.sh
./k3s/cluster-config/rancher/ui.sh
```

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ DNS
–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ DNS-–∑–∞–ø–∏—Å–∏ –≤ Cloudflare:
```
–¢–∏–ø: A
–ò–º—è: *.k3s.larek.tech
–°–æ–¥–µ—Ä–∂–∏–º–æ–µ: <–≤–∞—à-–≤–Ω–µ—à–Ω–∏–π-ip>
–ü—Ä–æ–∫—Å–∏: –¢–æ–ª—å–∫–æ DNS
```

## –û—Ç–ª–∞–¥–∫–∞

### –†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
- **–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –Ω–µ –≤—ã–¥–∞—ë—Ç—Å—è**: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ DNS-–∑–∞–ø–∏—Å—å `dig TXT _acme-challenge.rancher.k3s.larek.tech`
- **Rancher UI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω**: `kubectl get certificate -n cattle-system`
- **–ü—Ä–æ–±–ª–µ–º—ã —Å DNS**: —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `*.k3s.larek.tech` —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –≤–∞—à –≤–Ω–µ—à–Ω–∏–π IP

### –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∫–ª–∞—Å—Ç–µ—Ä–∞
kubectl get nodes -o wide

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å cert-manager
kubectl get clusterissuer
kubectl get certificate -A

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ Rancher
kubectl get pods -n cattle-system

# –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ cert-manager
kubectl logs -n cert-manager deployment/cert-manager -f
```